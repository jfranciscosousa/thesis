\chapter{O Problema e os seus Desafios}

O problema que se pretende trabalhar nesta dissertação reside na diversidade e heterogeneidade das APIs e serviços IoT, levando a muitos entraves no desenvolvimento de aplicações nesta área, e, para além disso, uma vez que cada dispositivo possui a sua própria API proprietária, o desenvolvimento de novas aplicações torna-se moroso e mais complexo. As soluções existentes não são orientadas especificamente ao espaço casa, e as poucas que estão orientadas a este, são proprietárias e possuem restrições de sistemas operativos, não sendo totalmente abertas.  As soluções open-source existentes normalmente requerem muita configuração e perícia tecnológica para a sua utilização e não são otimizadas para utilização em ambientes cloud, sendo de acesso exclusivo na rede local.

O objetivo deste projeto é portanto elaborar uma camada de serviço, middleware ou seja, que efetue a ligação entre os vários dispositivos do espaço casa e as aplicações clientes, abstraindo o espaço casa e os seus dispositivos para um acesso uniforme a estes recursos. Este componente deverá efetuar toda a gestão dos dispositivos das casas dos utilizadores, assim como outros serviços básicos de relevo para esta área, nomeadamente, auto-configuração e descoberta de dispositivos na rede, monitorização do espaço casa e automação e programação dos dispositivos, de modo a que estes possam executar ações sem o input direto dos utilizadores. O sistema deverá suportar o registo de vários utilizadores e a adição das suas casas, assim como os dispositivos nelas presentes, ao sistema. O serviço deverá portanto ser acessível via Internet.

Outro objetivo, mais a nível de funcionalidades e benefícios dados ao utilizador, consiste na criação de cenários e tarefas automatizadas. Um cenário consiste num conjunto de estados pré definidos a ser aplicados aos dispositivos de um espaço casa, por exemplo, desligar todas as luzes de uma divisão e fechar uma porta. Assim, conjuntos de estados aplicados várias vezes pelo utilizador podem ser agrupados, poupando o mesmo de manualmente aplicar os estados um a um. As tarefas automatizadas consistem na alteração dos estados dos dispositivos sem necessitar da interação direta do utilizador. Estas tarefas podem ser aplicadas com base no tempo, por exemplo, fechar as portas às 21:00 todos os dias, ou através do estado de outro dispositivo, como por exemplo, ligar as luzes da garagem caso o sensor de movimento lá colocado registe movimento.

Uma proposta para o desenvolvimento é recorrer a \textit{edge devices} para abstrair as implementações e interfaces dos dispositivos da rede local do utilizador, um princípio de \textit{edge computing}. Estes \textit{edge devices} efetuam a ligação entre os vários dispositivos do espaço casa e o serviço \textit{cloud}, removendo a parte da descoberta de novos dispositivos e configuração dos mesmos, colocando-a nos sistemas locais. Para implementar este \textit{edge device}, algo como o Raspberry PI poderá ser utilizado, ou qualquer tipo de placa de prototipagem disponível no mercado.

Idealmente, existirá um \textit{edge device} por casa, que se deverá auto-configurar e começar a pesquisar novos dispositivos compatíveis, já existentes na rede. Os \textit{edge devices}, também podendo ser apelidados de \textit{home gateways}, deverão então gerir e abstrair todos os controlos dos dispositivos conectados a si, fornecendo uma API bem estruturada para controlo destes mesmos. O serviço cloud tem como função permitir ao utilizador aceder aos seus dispositivos via o \textit{home gateway}, mesmo não estando na rede local. Um dos objetivos é possibilitar o controlo dos \textit{edge devices} mesmo sem conectividade à Internet, desde que o utilizador esteja presente na mesma rede destes dispositivos. De notar, que para aceder aos \textit{home gateways} e através disso, aos dispositivos do utilizador, é necessário efetuar autenticação, uma vez que cada \textit{home gateway} estará associado a um utilizador.

\section{Desafios}

O desafio principal é o de criar um suporte às várias APIs dos dispositivos e a abstração das mesmas. Será necessário elaborar um mecanismo que agrupe vários dispositivos do mesmo tipo, mas com protocolos e APIs diferentes, numa só API uniforme disponibilizada por este \textit{middleware}. Por exemplo, dois tipos de termostatos, com funcionalidades semelhantes, mas de fabricantes diferentes e com APIs e protocolos diferentes, devem ser abstraídos num recurso tipo termostato, que possui um conjunto de métodos bem definidos para serem invocados pelas aplicações clientes.

Vai ser necessário ter em conta a conectividade entre os dispositivos e o \textit{middleware}, dado que maior parte dos consumidores possuem \textit{routers} configurados e controlados pelas ISPs, operando em modo NAT e com uma \textit{firewall} que bloqueia o acesso externo a recursos dentro da rede. Alguns dispositivos utilizam UPNP para efetuar \textit{port forwarding}, para tornar estes dispositivos acessíveis de qualquer rede externa. No entanto, UPNP possui várias falhas a nível de segurança, e este processo é um pouco instável, não funcionando em certas condições (variável de acordo com o \textit{router} e ISP). A solução em vista é \textit{network tunneling}, que irá ser detalhada mais à frente nesta dissertação.

Outros desafios são a segurança de todo o \textit{middleware}, que é um ponto importantíssimo uma vez que estamos a lidar muitas vezes com residências particulares, e deixar os seus dispositivos inseguros é problema muito grave. A eficiência e a escalabilidade do serviço são fatores a ter em conta, é necessário assegurar que o serviço tenha a possibilidade de crescer horizontalmente com o aumento de número de utilizadores. Além de tudo isto, será também importante manter boas práticas de desenvolvimento e arquiteturais, uma vez que um serviço deste género pode crescer bastante no que toca à dimensão e complexidade do código, de maneira a que a manutenção do código seja mais fácil.

Por fim, o último desafio será a simulação e a demonstração da interação com os dispositivos. Devido a problemas óbvios de financiamento e de recursos, não será possível adquirir muitos dispositivos existentes no mercado, portanto, uma das soluções será tentar encontrar emuladores ou implementações \textit{stub} dos dispositivos reais, como por exemplo, este \cite{hueemulator} emulador do Philips HUE. Caso algum tipo de dispositivos não possuam emuladores, esses mesmo serão implementados por conta própria.

\section{Funcionalidades}
\label{sec:funcionalidades}

Definido o problema e encontrados os desafios principais, irão agora ser delineadas as funcionalidades principais que deverão ser encontradas no \textit{middleware} e porventura na aplicação de demonstração.

\begin{enumerate}
    \item Abstração dos detalhes de implementação de cada dispositivo. O modo de operação deverá ser independente do tipo de dispositivo utilizado
    \item Garantir acesso aos dispositivos através da Internet, removendo a necessidade da presença na rede local onde os dispositivos estão instalados
    \item Gestão de utilizadores básica, incluindo registos e autenticação
    \item Gestão e manipulação de dispositivos IoT
    \item Agrupamento de dispositivos em localizações (espaço casa)
    \item Configuração de novos dispositivos deverá ser assistida e automatizada, através dum \textit{scanner} de dispositivos compatíveis
    \item Gestão e configuração de cenários
    \item Gestão e configuração de tarefas automatizadas, à base de expressões temporais ou com base no estado de outros dispositivos
\end{enumerate}
